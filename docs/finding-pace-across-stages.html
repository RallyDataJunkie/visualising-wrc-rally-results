<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Finding Pace Across Stages | Visualising WRC Rally Timing and Results Data</title>
  <meta name="description" content="An introduction to visualising timing and results data for WRC rally events." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Finding Pace Across Stages | Visualising WRC Rally Timing and Results Data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to visualising timing and results data for WRC rally events." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Finding Pace Across Stages | Visualising WRC Rally Timing and Results Data" />
  
  <meta name="twitter:description" content="An introduction to visualising timing and results data for WRC rally events." />
  

<meta name="author" content="Tony Hirst" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="visualising-results-for-multiple-stages.html"/>
<link rel="next" href="visualising-split-times.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<script src="libs/formattable_widget-binding-0.2.1/formattable_widget.js"></script>
<link href="libs/jquery-sparkline-2.1.2/jquery.sparkline.css" rel="stylesheet" />
<script src="libs/jquery-sparkline-2.1.2/jquery.sparkline.js"></script>
<script src="libs/sparkline-binding-2.0/sparkline.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><strong>Visualising WRC Rally Results and Timing Data</strong></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Index</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html"><i class="fa fa-check"></i><b>2</b> Accessing Data from the WRC Live Timing API</a>
<ul>
<li class="chapter" data-level="2.1" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#current-season-rallies"><i class="fa fa-check"></i><b>2.1</b> Current Season Rallies</a></li>
<li class="chapter" data-level="2.2" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#itinerary-lookup"><i class="fa fa-check"></i><b>2.2</b> Itinerary Lookup</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#leg-sections"><i class="fa fa-check"></i><b>2.2.1</b> Leg Sections</a></li>
<li class="chapter" data-level="2.2.2" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#time-controls"><i class="fa fa-check"></i><b>2.2.2</b> Time Controls</a></li>
<li class="chapter" data-level="2.2.3" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#stage-details"><i class="fa fa-check"></i><b>2.2.3</b> Stage Details</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#competitor-details"><i class="fa fa-check"></i><b>2.3</b> Competitor Details</a></li>
<li class="chapter" data-level="2.4" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#penalties-and-retirements"><i class="fa fa-check"></i><b>2.4</b> Penalties and Retirements</a></li>
<li class="chapter" data-level="2.5" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#results-and-stage-winner"><i class="fa fa-check"></i><b>2.5</b> Results and Stage Winner</a></li>
<li class="chapter" data-level="2.6" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#stage-result"><i class="fa fa-check"></i><b>2.6</b> Stage Result</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#getting-stage-results-for-multiple-stages"><i class="fa fa-check"></i><b>2.6.1</b> Getting Stage Results for Multiple Stages</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#stage-times"><i class="fa fa-check"></i><b>2.7</b> Stage Times</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#getting-stage-times-for-multiple-stages"><i class="fa fa-check"></i><b>2.7.1</b> Getting Stage Times for Multiple Stages</a></li>
<li class="chapter" data-level="2.7.2" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#getting-wide-stage-times-for-multiple-stages"><i class="fa fa-check"></i><b>2.7.2</b> Getting Wide Stage Times for Multiple Stages</a></li>
<li class="chapter" data-level="2.7.3" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#getting-wide-stage-positions"><i class="fa fa-check"></i><b>2.7.3</b> Getting Wide Stage Positions</a></li>
<li class="chapter" data-level="2.7.4" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#getting-generic-wide-dataframes"><i class="fa fa-check"></i><b>2.7.4</b> Getting Generic Wide Dataframes</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#split-times"><i class="fa fa-check"></i><b>2.8</b> Split Times</a>
<ul>
<li class="chapter" data-level="2.8.1" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#driver-split-times-detail"><i class="fa fa-check"></i><b>2.8.1</b> Driver Split Times Detail</a></li>
<li class="chapter" data-level="2.8.2" data-path="accessing-data-from-the-wrc-live-timing-api.html"><a href="accessing-data-from-the-wrc-live-timing-api.html#wide-driver-split-times"><i class="fa fa-check"></i><b>2.8.2</b> Wide Driver Split Times</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html"><i class="fa fa-check"></i><b>3</b> Visualising Results for a Single Stage</a>
<ul>
<li class="chapter" data-level="3.1" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#load-base-data"><i class="fa fa-check"></i><b>3.1</b> Load Base Data</a></li>
<li class="chapter" data-level="3.2" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#get-stage-results-data"><i class="fa fa-check"></i><b>3.2</b> Get Stage Results Data</a></li>
<li class="chapter" data-level="3.3" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#previewing-stage-results-data"><i class="fa fa-check"></i><b>3.3</b> Previewing Stage Results Data</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#adding-entry-metadata"><i class="fa fa-check"></i><b>3.3.1</b> Adding Entry Metadata</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#adding-stage-metadata-to-table-captions"><i class="fa fa-check"></i><b>3.4</b> Adding Stage Metadata to Table Captions</a></li>
<li class="chapter" data-level="3.5" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#colour-highlighting-stage-results"><i class="fa fa-check"></i><b>3.5</b> Colour Highlighting Stage Results</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#heatmap-style-column-cell-backgrounds"><i class="fa fa-check"></i><b>3.5.1</b> Heatmap Style Column Cell Backgrounds</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#an-aside-calculating-diff-and-gap-times"><i class="fa fa-check"></i><b>3.6</b> An Aside — Calculating DIFF and GAP times</a></li>
<li class="chapter" data-level="3.7" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#rebasing-stage-results"><i class="fa fa-check"></i><b>3.7</b> Rebasing Stage Results</a></li>
<li class="chapter" data-level="3.8" data-path="visualising-results-for-a-single-stage.html"><a href="visualising-results-for-a-single-stage.html#colour-highlighting-rebased-values"><i class="fa fa-check"></i><b>3.8</b> Colour Highlighting Rebased Values</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="visualising-results-for-multiple-stages.html"><a href="visualising-results-for-multiple-stages.html"><i class="fa fa-check"></i><b>4</b> Visualising Results for Multiple Stages</a>
<ul>
<li class="chapter" data-level="4.1" data-path="visualising-results-for-multiple-stages.html"><a href="visualising-results-for-multiple-stages.html#load-base-data-1"><i class="fa fa-check"></i><b>4.1</b> Load Base Data</a></li>
<li class="chapter" data-level="4.2" data-path="visualising-results-for-multiple-stages.html"><a href="visualising-results-for-multiple-stages.html#retrieving-stage-results-for-multiple-stages"><i class="fa fa-check"></i><b>4.2</b> Retrieving Stage Results for Multiple Stages</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html"><i class="fa fa-check"></i><b>5</b> Finding Pace Across Stages</a>
<ul>
<li class="chapter" data-level="5.1" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#load-base-data-2"><i class="fa fa-check"></i><b>5.1</b> Load Base Data</a></li>
<li class="chapter" data-level="5.2" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#defining-pace"><i class="fa fa-check"></i><b>5.2</b> Defining Pace</a></li>
<li class="chapter" data-level="5.3" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#calculating-stage-pace"><i class="fa fa-check"></i><b>5.3</b> Calculating Stage Pace</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#calculating-pace-for-a-single-stage"><i class="fa fa-check"></i><b>5.3.1</b> Calculating Pace for a Single Stage</a></li>
<li class="chapter" data-level="5.3.2" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#calculating-pace-for-multiple-stages"><i class="fa fa-check"></i><b>5.3.2</b> Calculating Pace for Multiple Stages</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#rebasing-stage-pace"><i class="fa fa-check"></i><b>5.4</b> Rebasing Stage Pace</a></li>
<li class="chapter" data-level="5.5" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#visualising-stage-pace-using-pace-maps"><i class="fa fa-check"></i><b>5.5</b> Visualising Stage Pace Using Pace Maps</a></li>
<li class="chapter" data-level="5.6" data-path="finding-pace-across-stages.html"><a href="finding-pace-across-stages.html#off-the-pace-charts"><i class="fa fa-check"></i><b>5.6</b> Off-the-Pace Charts</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="visualising-split-times.html"><a href="visualising-split-times.html"><i class="fa fa-check"></i><b>6</b> Visualising Split Times</a>
<ul>
<li class="chapter" data-level="6.1" data-path="visualising-split-times.html"><a href="visualising-split-times.html#load-base-data-3"><i class="fa fa-check"></i><b>6.1</b> Load Base Data</a></li>
<li class="chapter" data-level="6.2" data-path="visualising-split-times.html"><a href="visualising-split-times.html#get-splits-data"><i class="fa fa-check"></i><b>6.2</b> Get Splits Data</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="visualising-split-times.html"><a href="visualising-split-times.html#wide-driver-split-times-1"><i class="fa fa-check"></i><b>6.2.1</b> Wide Driver Split Times</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="visualising-split-times.html"><a href="visualising-split-times.html#rebasing-split-times"><i class="fa fa-check"></i><b>6.3</b> Rebasing Split Times</a></li>
<li class="chapter" data-level="6.4" data-path="visualising-split-times.html"><a href="visualising-split-times.html#visualising-rebased-split-times-using-sparklines"><i class="fa fa-check"></i><b>6.4</b> Visualising Rebased Split Times Using Sparklines</a></li>
<li class="chapter" data-level="6.5" data-path="visualising-split-times.html"><a href="visualising-split-times.html#finding-the-rank-position-at-each-split-point"><i class="fa fa-check"></i><b>6.5</b> Finding the Rank Position at Each Split Point</a></li>
<li class="chapter" data-level="6.6" data-path="visualising-split-times.html"><a href="visualising-split-times.html#finding-split-section-durations"><i class="fa fa-check"></i><b>6.6</b> Finding Split Section Durations</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="visualising-split-times.html"><a href="visualising-split-times.html#finding-split-section-ranks"><i class="fa fa-check"></i><b>6.6.1</b> Finding Split Section Ranks</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="visualising-split-times.html"><a href="visualising-split-times.html#adding-overall-stage-time-to-the-split-times"><i class="fa fa-check"></i><b>6.7</b> Adding Overall Stage Time to the Split Times</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="finding-pace-across-splits.html"><a href="finding-pace-across-splits.html"><i class="fa fa-check"></i><b>7</b> Finding Pace Across Splits</a>
<ul>
<li class="chapter" data-level="7.1" data-path="finding-pace-across-splits.html"><a href="finding-pace-across-splits.html#load-base-data-4"><i class="fa fa-check"></i><b>7.1</b> Load Base Data</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://rallydatajunkie.com/"><em>RallyDataJunkie.com</em></a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Visualising WRC Rally Timing and Results Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="finding-pace-across-stages" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Finding Pace Across Stages</h1>
<p>Average speed on a rally is all very well, but it’s not the most useful of metrics for making sense of what’s actually going on in a rally. Far more useful is the notion of <em>pace</em> the reciprocal of a speed like measure, that tells you how many seconds it’s taking each driver to cover one kilometer.</p>
<p>Knowing the pace allows you to make more direct comparisons between drivers, as well as simplifying rule of thumb calculations, like what sort of pace advantage a driver needs to make up the 2s to the leader over the remaining 100 kilometers available in the final four stages…</p>
<p>In this chapter, we look at some simple pace calculations, rebase pace values relative to a specified driver, and explore a couple of ways of visualising differential pace over the course of a rally in the form of <em>pace maps</em> and <em>off-the-pace</em> charts.</p>
<div id="load-base-data-2" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Load Base Data</h2>
<p>To get the stage data from a standing start, we can load in the current season list, select the rally we want, look up the itinerary from the rally, extract the sections and then the stages, and from that access the stage ID for the stage or stages we are interested in.</p>
<p>Load in the helper functions:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="finding-pace-across-stages.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;code/wrc-api.R&#39;</span>)</span></code></pre></div>
<p>And get the base data:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="finding-pace-across-stages.html#cb132-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> <span class="fu">get_active_season</span>()</span>
<span id="cb132-2"><a href="finding-pace-across-stages.html#cb132-2" aria-hidden="true" tabindex="-1"></a>eventId <span class="ot">=</span> <span class="fu">get_eventId_from_name</span>(s, <span class="st">&#39;arctic&#39;</span>)</span>
<span id="cb132-3"><a href="finding-pace-across-stages.html#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="finding-pace-across-stages.html#cb132-4" aria-hidden="true" tabindex="-1"></a>itinerary <span class="ot">=</span> <span class="fu">get_itinerary</span>(eventId)</span>
<span id="cb132-5"><a href="finding-pace-across-stages.html#cb132-5" aria-hidden="true" tabindex="-1"></a>sections <span class="ot">=</span> <span class="fu">get_sections</span>(itinerary)</span>
<span id="cb132-6"><a href="finding-pace-across-stages.html#cb132-6" aria-hidden="true" tabindex="-1"></a>stages <span class="ot">=</span> <span class="fu">get_stages</span>(sections)</span>
<span id="cb132-7"><a href="finding-pace-across-stages.html#cb132-7" aria-hidden="true" tabindex="-1"></a>stages_lookup <span class="ot">=</span> <span class="fu">get_stages_lookup</span>(stages)</span>
<span id="cb132-8"><a href="finding-pace-across-stages.html#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="finding-pace-across-stages.html#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Driver details</span></span>
<span id="cb132-10"><a href="finding-pace-across-stages.html#cb132-10" aria-hidden="true" tabindex="-1"></a>cars <span class="ot">=</span> <span class="fu">get_car_data</span>(entries)</span></code></pre></div>
<p>Get a sample stage ID:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="finding-pace-across-stages.html#cb133-1" aria-hidden="true" tabindex="-1"></a>stageId <span class="ot">=</span> stages_lookup[[<span class="st">&#39;SS3&#39;</span>]]</span></code></pre></div>
</div>
<div id="defining-pace" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Defining Pace</h2>
<p>With variable stage distances on a stage rally, metrics such as average speed provide one way of comparing performances across stage, calculated as <span class="math inline">\(\textrm{stage_time}/\textrm{stage_distance}\)</span> with units of <em>kilometers</em> or <em>miles per hour</em>.</p>
<p>A more useful measure, particularly in rally terms, is the notion of <em>pace</em>, typically given with units of <em>seconds per kilometer</em>. <em>Speed</em> tells us much quickly a car covers distance in unit time; <em>pace</em> gives us an indication of how much time is required to travel a unit distance.</p>
<p>When used as a rebased difference measure between drivers, pace difference allows us to rapidly calculate how much time a driver is likely to gain or lose over a particular stage distance as per the word equation <span class="math inline">\(\textrm{time_gain}=\textrm{stage_distance}\cdot\textrm{pace_difference}\)</span>.</p>
<p>Basic pace itself is given as <span class="math inline">\(\textrm{pace}=\textrm{time}/\textrm{distance}\)</span>.</p>
<p>Developing our rally algebra, we might identify the stage distance for stage <span class="math inline">\(S\)</span> as <span class="math inline">\(d_S\)</span>. For a stage time by driver <span class="math inline">\(i\)</span> of <span class="math inline">\({_S}t_i\)</span> the stage pace <span class="math inline">\({_S}p_i\)</span> for driver <span class="math inline">\(i\)</span> on stage <span class="math inline">\(S\)</span> is then given as:</p>
<p><span class="math display">\[
{_S}p_i = \frac{{_S}t_i}{d_S}
\]</span></p>
</div>
<div id="calculating-stage-pace" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Calculating Stage Pace</h2>
<p>We can calculate stage pace from stage times and stage distances.</p>
<p>We can find stages distances directly from the <code>stages</code> dataframe:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="finding-pace-across-stages.html#cb134-1" aria-hidden="true" tabindex="-1"></a>stages <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&#39;code&#39;</span>,<span class="st">&#39;distance&#39;</span>)) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   code distance
## 1  SS1    31.05
## 2  SS2    31.05
## 3  SS3    24.43</code></pre>
<div id="calculating-pace-for-a-single-stage" class="section level3" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Calculating Pace for a Single Stage</h3>
<p>Let’s start by looking a single stage using a recipe we have used before:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="finding-pace-across-stages.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example stage code</span></span>
<span id="cb136-2"><a href="finding-pace-across-stages.html#cb136-2" aria-hidden="true" tabindex="-1"></a>stage_code <span class="ot">=</span> <span class="st">&#39;SS3&#39;</span></span>
<span id="cb136-3"><a href="finding-pace-across-stages.html#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="finding-pace-across-stages.html#cb136-4" aria-hidden="true" tabindex="-1"></a>stageId <span class="ot">=</span> stages_lookup[[stage_code]]</span>
<span id="cb136-5"><a href="finding-pace-across-stages.html#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="finding-pace-across-stages.html#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the stage distance</span></span>
<span id="cb136-7"><a href="finding-pace-across-stages.html#cb136-7" aria-hidden="true" tabindex="-1"></a>stage_distance <span class="ot">=</span> stages[stages[<span class="st">&#39;code&#39;</span>]<span class="sc">==</span>stage_code, <span class="st">&#39;distance&#39;</span>]</span>
<span id="cb136-8"><a href="finding-pace-across-stages.html#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="finding-pace-across-stages.html#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Get driver metadata</span></span>
<span id="cb136-10"><a href="finding-pace-across-stages.html#cb136-10" aria-hidden="true" tabindex="-1"></a>cars <span class="ot">=</span> <span class="fu">get_car_data</span>(entries)</span>
<span id="cb136-11"><a href="finding-pace-across-stages.html#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="finding-pace-across-stages.html#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stage times with merged in driver metadata</span></span>
<span id="cb136-13"><a href="finding-pace-across-stages.html#cb136-13" aria-hidden="true" tabindex="-1"></a>stage_times <span class="ot">=</span> <span class="fu">get_stage_times</span>(eventId, stageId) <span class="sc">%&gt;%</span></span>
<span id="cb136-14"><a href="finding-pace-across-stages.html#cb136-14" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">arrange</span>(position) <span class="sc">%&gt;%</span></span>
<span id="cb136-15"><a href="finding-pace-across-stages.html#cb136-15" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb136-16"><a href="finding-pace-across-stages.html#cb136-16" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># Merge in the entries data</span></span>
<span id="cb136-17"><a href="finding-pace-across-stages.html#cb136-17" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">merge</span>(cars, <span class="at">by=</span><span class="st">&#39;entryId&#39;</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb136-18"><a href="finding-pace-across-stages.html#cb136-18" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># Convert milliseconds to seconds</span></span>
<span id="cb136-19"><a href="finding-pace-across-stages.html#cb136-19" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">TimeInS =</span> elapsedDurationMs<span class="sc">/</span><span class="dv">1000</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb136-20"><a href="finding-pace-across-stages.html#cb136-20" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># Limit columns and set column order</span></span>
<span id="cb136-21"><a href="finding-pace-across-stages.html#cb136-21" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&#39;position&#39;</span>, <span class="st">&#39;identifier&#39;</span>,</span>
<span id="cb136-22"><a href="finding-pace-across-stages.html#cb136-22" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;code&#39;</span>, <span class="st">&#39;TimeInS&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb136-23"><a href="finding-pace-across-stages.html#cb136-23" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># The merge may upset the row order</span></span>
<span id="cb136-24"><a href="finding-pace-across-stages.html#cb136-24" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># so reset the order again</span></span>
<span id="cb136-25"><a href="finding-pace-across-stages.html#cb136-25" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">arrange</span>(position) <span class="sc">%&gt;%</span></span>
<span id="cb136-26"><a href="finding-pace-across-stages.html#cb136-26" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># Improve column names by renaming them</span></span>
<span id="cb136-27"><a href="finding-pace-across-stages.html#cb136-27" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">rename</span>(<span class="at">Pos=</span>position,</span>
<span id="cb136-28"><a href="finding-pace-across-stages.html#cb136-28" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Car =</span> identifier,</span>
<span id="cb136-29"><a href="finding-pace-across-stages.html#cb136-29" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Code =</span> code,</span>
<span id="cb136-30"><a href="finding-pace-across-stages.html#cb136-30" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">Time (s)</span><span class="st">`</span> <span class="ot">=</span> TimeInS)</span>
<span id="cb136-31"><a href="finding-pace-across-stages.html#cb136-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-32"><a href="finding-pace-across-stages.html#cb136-32" aria-hidden="true" tabindex="-1"></a><span class="fu">formattable</span>(stage_times )</span></code></pre></div>
<table class="table table-condensed">
<thead>
<tr>
<th style="text-align:right;">
Pos
</th>
<th style="text-align:right;">
Car
</th>
<th style="text-align:right;">
Code
</th>
<th style="text-align:right;">
Time (s)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
TÄN
</td>
<td style="text-align:right;">
834.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
NEU
</td>
<td style="text-align:right;">
835.5
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
SOL
</td>
<td style="text-align:right;">
839.1
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
ROV
</td>
<td style="text-align:right;">
840.2
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:right;">
BRE
</td>
<td style="text-align:right;">
841.9
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
OGI
</td>
<td style="text-align:right;">
842.0
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
KAT
</td>
<td style="text-align:right;">
843.2
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
LOU
</td>
<td style="text-align:right;">
844.3
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
EVA
</td>
<td style="text-align:right;">
845.8
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
SUN
</td>
<td style="text-align:right;">
846.9
</td>
</tr>
</tbody>
</table>
<p>We can now calculate pace as the stage time divided by the stage distance:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="finding-pace-across-stages.html#cb137-1" aria-hidden="true" tabindex="-1"></a>stage_times<span class="sc">$</span>pace <span class="ot">=</span> stage_times<span class="sc">$</span><span class="st">&#39;Time (s)&#39;</span> <span class="sc">/</span> stage_distance</span>
<span id="cb137-2"><a href="finding-pace-across-stages.html#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="finding-pace-across-stages.html#cb137-3" aria-hidden="true" tabindex="-1"></a>stage_times</span></code></pre></div>
<pre><code>##    Pos Car Code Time (s)     pace
## 1    1   8  TÄN    834.5 34.15882
## 2    2  11  NEU    835.5 34.19975
## 3    3   2  SOL    839.1 34.34711
## 4    4  69  ROV    840.2 34.39214
## 5    5  42  BRE    841.9 34.46173
## 6    6   1  OGI    842.0 34.46582
## 7    7  18  KAT    843.2 34.51494
## 8    8   7  LOU    844.3 34.55997
## 9    9  33  EVA    845.8 34.62137
## 10  10   3  SUN    846.9 34.66639</code></pre>
</div>
<div id="calculating-pace-for-multiple-stages" class="section level3" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Calculating Pace for Multiple Stages</h3>
<p>First, let’s get the data for all the stages:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="finding-pace-across-stages.html#cb139-1" aria-hidden="true" tabindex="-1"></a>stage_list <span class="ot">=</span> <span class="fu">get_stage_list</span>(stages)</span>
<span id="cb139-2"><a href="finding-pace-across-stages.html#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="finding-pace-across-stages.html#cb139-3" aria-hidden="true" tabindex="-1"></a>multi_stage_times <span class="ot">=</span> <span class="fu">get_multi_stage_times</span>(stage_list)</span>
<span id="cb139-4"><a href="finding-pace-across-stages.html#cb139-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-5"><a href="finding-pace-across-stages.html#cb139-5" aria-hidden="true" tabindex="-1"></a>multi_stage_times <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##     stageTimeId stageId entryId elapsedDurationMs  elapsedDuration    status
## 539       96810    1749   21571           1301693 00:21:41.6930000 Completed
## 540       96793    1749   21541                NA             &lt;NA&gt;       DNS
##      source position diffFirstMs        diffFirst diffPrevMs         diffPrev
## 539 Default       52      699224 00:11:39.2240000     153590 00:02:33.5900000
## 540 Default       NA          NA             &lt;NA&gt;         NA             &lt;NA&gt;</code></pre>
<p>We can generate the pace by adding the stage distance as an extra column and performing the pace calculation.</p>
<p>We’ll also take the opportunity to merge in driver metadata and limit cars to WRC group entries:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="finding-pace-across-stages.html#cb141-1" aria-hidden="true" tabindex="-1"></a>multi_stage_pace <span class="ot">=</span> multi_stage_times <span class="sc">%&gt;%</span></span>
<span id="cb141-2"><a href="finding-pace-across-stages.html#cb141-2" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">merge</span>(stages[,<span class="fu">c</span>(<span class="st">&#39;stageId&#39;</span> ,<span class="st">&#39;distance&#39;</span>,</span>
<span id="cb141-3"><a href="finding-pace-across-stages.html#cb141-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;number&#39;</span>, <span class="st">&#39;code&#39;</span>)],</span>
<span id="cb141-4"><a href="finding-pace-across-stages.html#cb141-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by=</span><span class="st">&#39;stageId&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-5"><a href="finding-pace-across-stages.html#cb141-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">elapsedDurationS =</span> elapsedDurationMs <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb141-6"><a href="finding-pace-across-stages.html#cb141-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">pace =</span> elapsedDurationS <span class="sc">/</span> distance) <span class="sc">%&gt;%</span></span>
<span id="cb141-7"><a href="finding-pace-across-stages.html#cb141-7" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">merge</span>(cars[,<span class="fu">c</span>(<span class="st">&#39;entryId&#39;</span>,<span class="st">&#39;drivername&#39;</span>,</span>
<span id="cb141-8"><a href="finding-pace-across-stages.html#cb141-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;code&#39;</span>, <span class="st">&#39;groupname&#39;</span>)],</span>
<span id="cb141-9"><a href="finding-pace-across-stages.html#cb141-9" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by=</span><span class="st">&#39;entryId&#39;</span>,</span>
<span id="cb141-10"><a href="finding-pace-across-stages.html#cb141-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">suffixes=</span><span class="fu">c</span>(<span class="st">&#39;&#39;</span>,<span class="st">&#39;_driver&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb141-11"><a href="finding-pace-across-stages.html#cb141-11" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(groupname<span class="sc">==</span><span class="st">&#39;WRC&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-12"><a href="finding-pace-across-stages.html#cb141-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&#39;stageId&#39;</span>, <span class="st">&#39;number&#39;</span>, <span class="st">&#39;code_driver&#39;</span>,</span>
<span id="cb141-13"><a href="finding-pace-across-stages.html#cb141-13" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;elapsedDurationS&#39;</span>, <span class="st">&#39;pace&#39;</span>, <span class="st">&#39;code&#39;</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb141-14"><a href="finding-pace-across-stages.html#cb141-14" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">arrange</span>(number, elapsedDurationS)</span>
<span id="cb141-15"><a href="finding-pace-across-stages.html#cb141-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-16"><a href="finding-pace-across-stages.html#cb141-16" aria-hidden="true" tabindex="-1"></a>multi_stage_pace <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   stageId number code_driver elapsedDurationS     pace code
## 1    1747      1         TÄN            957.8 30.84702  SS1
## 2    1747      1         BRE            961.4 30.96296  SS1
## 3    1747      1         ROV            968.4 31.18841  SS1</code></pre>
<p>Create a mapping from stage ID to stage codes and cast the ordered list of stage Ids to an ordered list of stage codes:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="finding-pace-across-stages.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a stage code mapping function</span></span>
<span id="cb143-2"><a href="finding-pace-across-stages.html#cb143-2" aria-hidden="true" tabindex="-1"></a>stages_lookup_code <span class="ot">=</span> <span class="fu">get_stages_lookup</span>(stages, <span class="st">&#39;stageId&#39;</span>, <span class="st">&#39;code&#39;</span>)</span>
<span id="cb143-3"><a href="finding-pace-across-stages.html#cb143-3" aria-hidden="true" tabindex="-1"></a>stage_code_map <span class="ot">=</span> <span class="cf">function</span>(stageId)</span>
<span id="cb143-4"><a href="finding-pace-across-stages.html#cb143-4" aria-hidden="true" tabindex="-1"></a>  stages_lookup_code[[<span class="fu">as.character</span>(stageId)]]</span>
<span id="cb143-5"><a href="finding-pace-across-stages.html#cb143-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-6"><a href="finding-pace-across-stages.html#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Map stage ID column names to stage codes</span></span>
<span id="cb143-7"><a href="finding-pace-across-stages.html#cb143-7" aria-hidden="true" tabindex="-1"></a>stage_codes <span class="ot">=</span> <span class="fu">unlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(stage_list,</span>
<span id="cb143-8"><a href="finding-pace-across-stages.html#cb143-8" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span> (x) <span class="fu">stage_code_map</span>(x)))</span>
<span id="cb143-9"><a href="finding-pace-across-stages.html#cb143-9" aria-hidden="true" tabindex="-1"></a>stage_codes</span></code></pre></div>
<pre><code>##  [1] &quot;SS1&quot;  &quot;SS2&quot;  &quot;SS3&quot;  &quot;SS4&quot;  &quot;SS5&quot;  &quot;SS6&quot;  &quot;SS7&quot;  &quot;SS8&quot;  &quot;SS9&quot;  &quot;SS10&quot;</code></pre>
<p>Use the generic widener function to widen the pace dataframe to give the pace for each driver on each stage:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="finding-pace-across-stages.html#cb145-1" aria-hidden="true" tabindex="-1"></a>pace_wide <span class="ot">=</span> <span class="fu">get_multi_stage_generic_wide</span>(multi_stage_pace,</span>
<span id="cb145-2"><a href="finding-pace-across-stages.html#cb145-2" aria-hidden="true" tabindex="-1"></a>                                         stage_codes, <span class="st">&#39;pace&#39;</span>,</span>
<span id="cb145-3"><a href="finding-pace-across-stages.html#cb145-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="co"># Unique group keys required</span></span>
<span id="cb145-4"><a href="finding-pace-across-stages.html#cb145-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="co"># Driver code not guaranteed unique</span></span>
<span id="cb145-5"><a href="finding-pace-across-stages.html#cb145-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">group_key=</span><span class="fu">c</span>(<span class="st">&#39;code_driver&#39;</span>),</span>
<span id="cb145-6"><a href="finding-pace-across-stages.html#cb145-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">spread_key=</span><span class="st">&#39;code&#39;</span>)</span>
<span id="cb145-7"><a href="finding-pace-across-stages.html#cb145-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-8"><a href="finding-pace-across-stages.html#cb145-8" aria-hidden="true" tabindex="-1"></a>pace_wide <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 11
## # Groups:   code_driver [3]
##   code_driver   SS1   SS2   SS3   SS4   SS5   SS6   SS7   SS8   SS9  SS10
##   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 BER          32.7  32.8  58.7  57.6  48.8  58.8  57.7  49.3  28.7  28.6
## 2 BRE          31.0  31.1  34.5  27.7  27.3  34.8  28.0  28.1  27.3  26.8
## 3 EVA          31.4  31.2  34.6  27.5  27.1  34.9  27.8  28.3  27.0  27.1</code></pre>
</div>
</div>
<div id="rebasing-stage-pace" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Rebasing Stage Pace</h2>
<p>We can rebase the stage pace according to a specific driver:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="finding-pace-across-stages.html#cb147-1" aria-hidden="true" tabindex="-1"></a>example_driver <span class="ot">=</span> pace_wide[<span class="dv">2</span>,]<span class="sc">$</span>code_driver</span>
<span id="cb147-2"><a href="finding-pace-across-stages.html#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="finding-pace-across-stages.html#cb147-3" aria-hidden="true" tabindex="-1"></a>pace_wide_rebased <span class="ot">=</span> <span class="fu">rebase</span>(pace_wide, example_driver, stage_codes,</span>
<span id="cb147-4"><a href="finding-pace-across-stages.html#cb147-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">id_col=</span><span class="st">&#39;code_driver&#39;</span>)</span>
<span id="cb147-5"><a href="finding-pace-across-stages.html#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="finding-pace-across-stages.html#cb147-6" aria-hidden="true" tabindex="-1"></a>pace_wide_rebased <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 11
## # Groups:   code_driver [3]
##   code_driver   SS1    SS2    SS3    SS4    SS5     SS6    SS7    SS8    SS9
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 BER         1.70  1.75   24.3   29.9   21.4   24.0    29.7   21.1    1.37 
## 2 BRE         0     0       0      0      0      0       0      0      0    
## 3 EVA         0.422 0.0870  0.160 -0.246 -0.231  0.0982 -0.286  0.181 -0.289
## # … with 1 more variable: SS10 &lt;dbl&gt;</code></pre>
<p>More abstractly, the rebased pace, <span class="math inline">\({_S}p_i^j\)</span>, for driver <span class="math inline">\(i\)</span> relative to driver <span class="math inline">\(j\)</span> on stage <span class="math inline">\(S\)</span> is given as:</p>
<p><span class="math display">\[
{_S}p_i^j = {_S}p_i - {_S}p_j = \frac{{_S}t_i - {_S}t_j}{d_S} = \frac{{_S}t_i^j}{d_S}
\]</span></p>
</div>
<div id="visualising-stage-pace-using-pace-maps" class="section level2" number="5.5">
<h2><span class="header-section-number">5.5</span> Visualising Stage Pace Using Pace Maps</h2>
<p>To compare pace, it is useful to look at rebased pace times relative to a particular driver and also indicate the length of stage with which particular pace levels are associated.</p>
<p>We can do this with a chart that presents distance into stage along the horizontal x-axis and relative pace on the y axis, using a line to indicate the pace for each driver relative to a specified driver.</p>
<p>One of the easiest way of plotting charts is to plot from a tidy dataframe, so let’s cast the rebased wide pace dataframe back to a long form and also add in the distance into stage at the start and end of each stage:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="finding-pace-across-stages.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb149-2"><a href="finding-pace-across-stages.html#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="finding-pace-across-stages.html#cb149-3" aria-hidden="true" tabindex="-1"></a>stage_range <span class="ot">=</span> <span class="fu">c</span>(<span class="at">start=</span>stage_codes[<span class="dv">1</span>],</span>
<span id="cb149-4"><a href="finding-pace-across-stages.html#cb149-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">end=</span>stage_codes[<span class="fu">length</span>(stage_codes)])</span>
<span id="cb149-5"><a href="finding-pace-across-stages.html#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="finding-pace-across-stages.html#cb149-6" aria-hidden="true" tabindex="-1"></a>stages<span class="sc">$</span>cum_dist <span class="ot">=</span> <span class="fu">cumsum</span>(stages<span class="sc">$</span>distance)</span>
<span id="cb149-7"><a href="finding-pace-across-stages.html#cb149-7" aria-hidden="true" tabindex="-1"></a>stages<span class="sc">$</span>start_dist <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, stages<span class="sc">$</span>cum_dist[<span class="sc">-</span><span class="fu">length</span>(stages<span class="sc">$</span>cum_dist)])</span>
<span id="cb149-8"><a href="finding-pace-across-stages.html#cb149-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-9"><a href="finding-pace-across-stages.html#cb149-9" aria-hidden="true" tabindex="-1"></a>pace_long <span class="ot">=</span> pace_wide_rebased <span class="sc">%&gt;%</span> </span>
<span id="cb149-10"><a href="finding-pace-across-stages.html#cb149-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">gather</span>(code, pace,</span>
<span id="cb149-11"><a href="finding-pace-across-stages.html#cb149-11" aria-hidden="true" tabindex="-1"></a>                       stage_range[<span class="st">&#39;start&#39;</span>]<span class="sc">:</span>stage_range[<span class="st">&#39;end&#39;</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb149-12"><a href="finding-pace-across-stages.html#cb149-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">merge</span>(stages[,<span class="fu">c</span>(<span class="st">&#39;code&#39;</span>, <span class="st">&#39;start_dist&#39;</span>, <span class="st">&#39;cum_dist&#39;</span>)],</span>
<span id="cb149-13"><a href="finding-pace-across-stages.html#cb149-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by=</span><span class="st">&#39;code&#39;</span>)</span>
<span id="cb149-14"><a href="finding-pace-across-stages.html#cb149-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-15"><a href="finding-pace-across-stages.html#cb149-15" aria-hidden="true" tabindex="-1"></a>pace_long <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   code code_driver      pace start_dist cum_dist
## 1  SS1         BER 1.7004831          0    31.05
## 2  SS1         BRE 0.0000000          0    31.05
## 3  SS1         EVA 0.4219002          0    31.05</code></pre>
<p>We can now construct a chart using line segments to represent the pace for each driver on each stage:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="finding-pace-across-stages.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb151-2"><a href="finding-pace-across-stages.html#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="finding-pace-across-stages.html#cb151-3" aria-hidden="true" tabindex="-1"></a>g0 <span class="ot">=</span> <span class="fu">ggplot</span>(pace_long, <span class="fu">aes</span>(<span class="at">group=</span>code_driver)) <span class="sc">+</span></span>
<span id="cb151-4"><a href="finding-pace-across-stages.html#cb151-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>,</span>
<span id="cb151-5"><a href="finding-pace-across-stages.html#cb151-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour=</span><span class="st">&#39;lightgrey&#39;</span>, <span class="at">linetype=</span><span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span></span>
<span id="cb151-6"><a href="finding-pace-across-stages.html#cb151-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x=</span>start_dist, <span class="at">xend=</span>cum_dist,</span>
<span id="cb151-7"><a href="finding-pace-across-stages.html#cb151-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y=</span>pace, <span class="at">yend=</span>pace),</span>
<span id="cb151-8"><a href="finding-pace-across-stages.html#cb151-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> <span class="st">&#39;lightgrey&#39;</span>)</span>
<span id="cb151-9"><a href="finding-pace-across-stages.html#cb151-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-10"><a href="finding-pace-across-stages.html#cb151-10" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> g0 <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x=</span>(start_dist<span class="sc">+</span>cum_dist)<span class="sc">/</span><span class="dv">2</span>,<span class="at">y=</span>pace<span class="fl">+0.03</span>,</span>
<span id="cb151-11"><a href="finding-pace-across-stages.html#cb151-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label=</span>code_driver,<span class="at">group=</span>code_driver),</span>
<span id="cb151-12"><a href="finding-pace-across-stages.html#cb151-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="dv">15</span>), <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb151-13"><a href="finding-pace-across-stages.html#cb151-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb151-14"><a href="finding-pace-across-stages.html#cb151-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-15"><a href="finding-pace-across-stages.html#cb151-15" aria-hidden="true" tabindex="-1"></a>g</span></code></pre></div>
<p><img src="images/finding-stage-pace-basic_stage_pace-1.png" width="672" /></p>
<p>We could highlight positive and negative differences in the label colourings:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="finding-pace-across-stages.html#cb152-1" aria-hidden="true" tabindex="-1"></a>g0 <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x=</span>(start_dist<span class="sc">+</span>cum_dist)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb152-2"><a href="finding-pace-across-stages.html#cb152-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y=</span><span class="fu">ifelse</span>(pace<span class="sc">&gt;</span><span class="dv">0</span>,pace<span class="fl">+0.03</span>,pace<span class="fl">-0.03</span>),</span>
<span id="cb152-3"><a href="finding-pace-across-stages.html#cb152-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label=</span>code_driver,<span class="at">group=</span>code_driver,</span>
<span id="cb152-4"><a href="finding-pace-across-stages.html#cb152-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color=</span>pace<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb152-5"><a href="finding-pace-across-stages.html#cb152-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="dv">15</span>), <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb152-6"><a href="finding-pace-across-stages.html#cb152-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-posneg_highlighted_stage_pace-1.png" width="672" /></p>
<p>We can also highlight values for a particular driver:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="finding-pace-across-stages.html#cb153-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_segment</span>(<span class="at">data=</span>pace_long[pace_long<span class="sc">$</span>code_driver<span class="sc">==</span><span class="st">&#39;EVA&#39;</span>,],</span>
<span id="cb153-2"><a href="finding-pace-across-stages.html#cb153-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x=</span>start_dist, <span class="at">xend=</span>cum_dist,</span>
<span id="cb153-3"><a href="finding-pace-across-stages.html#cb153-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y=</span>pace, <span class="at">yend=</span>pace, <span class="at">color =</span> pace<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb153-4"><a href="finding-pace-across-stages.html#cb153-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-driver_highlighted_stage_pace-1.png" width="672" /></p>
<p>Or abuse the <code>gghiglight</code> package to modify the aesthetics of unselected items:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="finding-pace-across-stages.html#cb154-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> gghighlight<span class="sc">::</span><span class="fu">gghighlight</span>(code_driver<span class="sc">==</span><span class="st">&#39;EVA&#39;</span>,</span>
<span id="cb154-2"><a href="finding-pace-across-stages.html#cb154-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">unhighlighted_params=</span><span class="fu">list</span>(<span class="at">alpha=</span><span class="fl">0.1</span>))</span></code></pre></div>
<p><img src="images/finding-stage-pace-driver_highlighted_stage_pace2-1.png" width="672" />
Alternatively, abuse <code>gghighlight()</code> again with a negative form of selection to highlight items:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="finding-pace-across-stages.html#cb155-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> gghighlight<span class="sc">::</span><span class="fu">gghighlight</span>(code_driver<span class="sc">!=</span><span class="st">&#39;EVA&#39;</span>,<span class="at">label_key=</span>code_driver,</span>
<span id="cb155-2"><a href="finding-pace-across-stages.html#cb155-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">unhighlighted_params=</span><span class="fu">list</span>(<span class="at">color=</span><span class="st">&#39;blue&#39;</span>))</span></code></pre></div>
<p><img src="images/finding-stage-pace-driver_highlighted_stage_pace3-1.png" width="672" /></p>
<p>We could even add a transparency layer bar to highlight the pace difference compared to a particular driver:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="finding-pace-across-stages.html#cb156-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_rect</span>(<span class="at">data=</span>pace_long[pace_long<span class="sc">$</span>code_driver<span class="sc">==</span><span class="st">&#39;EVA&#39;</span>,],</span>
<span id="cb156-2"><a href="finding-pace-across-stages.html#cb156-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">xmin=</span>start_dist, <span class="at">xmax=</span>cum_dist,</span>
<span id="cb156-3"><a href="finding-pace-across-stages.html#cb156-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ymin =</span> <span class="fu">ifelse</span>(pace<span class="sc">&gt;</span><span class="dv">0</span>,<span class="dv">0</span>,pace),</span>
<span id="cb156-4"><a href="finding-pace-across-stages.html#cb156-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ymax =</span> <span class="fu">ifelse</span>(pace<span class="sc">&gt;</span><span class="dv">0</span>,pace,<span class="dv">0</span>),</span>
<span id="cb156-5"><a href="finding-pace-across-stages.html#cb156-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill =</span> pace<span class="sc">&gt;</span><span class="dv">0</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)) <span class="sc">+</span></span>
<span id="cb156-6"><a href="finding-pace-across-stages.html#cb156-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-block_highlighted_stage_pace-1.png" width="672" /></p>
<p>To highlight stages, we could add a “banner” to the chart:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="finding-pace-across-stages.html#cb157-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_rect</span>(<span class="at">data=</span>pace_long[pace_long<span class="sc">$</span>code_driver<span class="sc">==</span>example_driver,],</span>
<span id="cb157-2"><a href="finding-pace-across-stages.html#cb157-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">xmin=</span><span class="dv">0</span>, <span class="at">xmax=</span><span class="fu">max</span>(cum_dist),</span>
<span id="cb157-3"><a href="finding-pace-across-stages.html#cb157-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymin =</span> <span class="fl">1.8</span>,  <span class="at">ymax =</span> <span class="fl">2.0</span>,</span>
<span id="cb157-4"><a href="finding-pace-across-stages.html#cb157-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha=</span><span class="dv">0</span>), <span class="at">fill =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span></span>
<span id="cb157-5"><a href="finding-pace-across-stages.html#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="at">data=</span>pace_long[pace_long<span class="sc">$</span>code_driver<span class="sc">==</span>example_driver,],</span>
<span id="cb157-6"><a href="finding-pace-across-stages.html#cb157-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x=</span>(cum_dist <span class="sc">+</span> start_dist)<span class="sc">/</span><span class="dv">2</span>, <span class="at">label=</span>code),</span>
<span id="cb157-7"><a href="finding-pace-across-stages.html#cb157-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">y=</span><span class="fl">1.9</span>, <span class="at">color=</span><span class="st">&#39;yellow&#39;</span>, <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb157-8"><a href="finding-pace-across-stages.html#cb157-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="at">data=</span>pace_long[pace_long<span class="sc">$</span>code_driver<span class="sc">==</span>example_driver,],</span>
<span id="cb157-9"><a href="finding-pace-across-stages.html#cb157-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x=</span>cum_dist, <span class="at">xend=</span>cum_dist,</span>
<span id="cb157-10"><a href="finding-pace-across-stages.html#cb157-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y=</span><span class="fl">1.8</span>, <span class="at">yend=</span><span class="fl">2.0</span>), <span class="at">color=</span><span class="st">&#39;yellow&#39;</span>) <span class="sc">+</span></span>
<span id="cb157-11"><a href="finding-pace-across-stages.html#cb157-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-banner_highlighted_stage_pace-1.png" width="672" /></p>
</div>
<div id="off-the-pace-charts" class="section level2" number="5.6">
<h2><span class="header-section-number">5.6</span> Off-the-Pace Charts</h2>
<p>Another way or reviewing pace is to consider the gap to leader, or rebased gap to a particular driver across the stages, using distance into stage along the x-axis to locate the x-value and gap (measured in seconds) along the y-axis. A moment’s consideration suggests that the gradient (<span class="math inline">\(\textrm{change_in_gap}/\textrm{change_in_distance}\)</span>) is a measure of pace. The slope of the line thus indicates relative pace between the focal driver and the other drivers.</p>
<p>As with the pace map, if we have the data in a long, tidy form, we can create charts from it quite straightforwardly. So let’s add in the accumulated distance into stage and accumulated stage time for each time:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="finding-pace-across-stages.html#cb158-1" aria-hidden="true" tabindex="-1"></a>off_the_pace <span class="ot">=</span> multi_stage_pace <span class="sc">%&gt;%</span></span>
<span id="cb158-2"><a href="finding-pace-across-stages.html#cb158-2" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">merge</span>(stages[,<span class="fu">c</span>(<span class="st">&#39;stageId&#39;</span>, <span class="st">&#39;cum_dist&#39;</span>)],</span>
<span id="cb158-3"><a href="finding-pace-across-stages.html#cb158-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">by=</span><span class="st">&#39;stageId&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-4"><a href="finding-pace-across-stages.html#cb158-4" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">arrange</span>(number) <span class="sc">%&gt;%</span></span>
<span id="cb158-5"><a href="finding-pace-across-stages.html#cb158-5" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">group_by</span>(code_driver) <span class="sc">%&gt;%</span></span>
<span id="cb158-6"><a href="finding-pace-across-stages.html#cb158-6" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">mutate</span>(<span class="at">totalDurationS =</span> <span class="fu">cumsum</span>(elapsedDurationS))</span>
<span id="cb158-7"><a href="finding-pace-across-stages.html#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="finding-pace-across-stages.html#cb158-8" aria-hidden="true" tabindex="-1"></a>off_the_pace <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 8
## # Groups:   code_driver [3]
##   stageId number code_driver elapsedDurationS  pace code  cum_dist
##     &lt;int&gt;  &lt;int&gt; &lt;chr&gt;                  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1    1747      1 TÄN                     958.  30.8 SS1       31.0
## 2    1747      1 BRE                     961.  31.0 SS1       31.0
## 3    1747      1 ROV                     968.  31.2 SS1       31.0
## # … with 1 more variable: totalDurationS &lt;dbl&gt;</code></pre>
<p>Now we can create a basic off-the pace chart:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="finding-pace-across-stages.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(off_the_pace, <span class="fu">aes</span>(<span class="at">x=</span>cum_dist, <span class="at">y=</span>totalDurationS,</span>
<span id="cb160-2"><a href="finding-pace-across-stages.html#cb160-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color=</span>code_driver)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="images/finding-stage-pace-off-the-pace-basic-1.png" width="672" /></p>
<p>As with the pace map, the chart is often most informative if we rebase it relative to a particular driver.</p>
<p>Let’s create a wide dataframe to simplify the rebasing process:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="finding-pace-across-stages.html#cb161-1" aria-hidden="true" tabindex="-1"></a>off_the_pace_wide <span class="ot">=</span> <span class="fu">get_multi_stage_generic_wide</span>(off_the_pace,</span>
<span id="cb161-2"><a href="finding-pace-across-stages.html#cb161-2" aria-hidden="true" tabindex="-1"></a>                                         stage_codes, <span class="st">&#39;totalDurationS&#39;</span>,</span>
<span id="cb161-3"><a href="finding-pace-across-stages.html#cb161-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">group_key=</span><span class="fu">c</span>(<span class="st">&#39;code_driver&#39;</span>),</span>
<span id="cb161-4"><a href="finding-pace-across-stages.html#cb161-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">spread_key=</span><span class="st">&#39;code&#39;</span>)</span>
<span id="cb161-5"><a href="finding-pace-across-stages.html#cb161-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-6"><a href="finding-pace-across-stages.html#cb161-6" aria-hidden="true" tabindex="-1"></a>off_the_pace_wide <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 11
## # Groups:   code_driver [3]
##   code_driver   SS1   SS2   SS3   SS4   SS5   SS6   SS7   SS8    SS9   SS10
##   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 BER         1014. 2034  3468. 4615. 5965. 7402. 8551. 9915. 10560  11204.
## 2 BRE          961. 1927. 2769. 3320. 4077. 4928. 5486. 6266.  6880.  7482.
## 3 EVA          974. 1943. 2788. 3335. 4085. 4939. 5492. 6276.  6883.  7491.</code></pre>
<p>Now we can rebase:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="finding-pace-across-stages.html#cb163-1" aria-hidden="true" tabindex="-1"></a>off_the_pace_wide_rebased <span class="ot">=</span> <span class="fu">rebase</span>(off_the_pace_wide,</span>
<span id="cb163-2"><a href="finding-pace-across-stages.html#cb163-2" aria-hidden="true" tabindex="-1"></a>                                   example_driver, stage_codes,</span>
<span id="cb163-3"><a href="finding-pace-across-stages.html#cb163-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">id_col=</span><span class="st">&#39;code_driver&#39;</span>)</span>
<span id="cb163-4"><a href="finding-pace-across-stages.html#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="finding-pace-across-stages.html#cb163-5" aria-hidden="true" tabindex="-1"></a>off_the_pace_wide_rebased <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 11
## # Groups:   code_driver [3]
##   code_driver   SS1   SS2   SS3    SS4    SS5    SS6    SS7    SS8    SS9   SS10
##   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 BER          52.8 107.  700.  1295.  1888.  2474.  3065.  3650.  3680.  3.72e3
## 2 BRE           0     0     0      0      0      0      0      0      0   0.    
## 3 EVA          13.1  15.8  19.7   14.8    8.4   10.8    5.1   10.1    3.6 8.90e0</code></pre>
<p>And cast back to the long, tidy form:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="finding-pace-across-stages.html#cb165-1" aria-hidden="true" tabindex="-1"></a>off_the_pace_long <span class="ot">=</span> off_the_pace_wide_rebased <span class="sc">%&gt;%</span> </span>
<span id="cb165-2"><a href="finding-pace-across-stages.html#cb165-2" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">gather</span>(code, totalDurationGapS,</span>
<span id="cb165-3"><a href="finding-pace-across-stages.html#cb165-3" aria-hidden="true" tabindex="-1"></a>                               stage_range[<span class="st">&#39;start&#39;</span>]<span class="sc">:</span>stage_range[<span class="st">&#39;end&#39;</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb165-4"><a href="finding-pace-across-stages.html#cb165-4" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">merge</span>(stages[,<span class="fu">c</span>(<span class="st">&#39;code&#39;</span>, <span class="st">&#39;cum_dist&#39;</span>)],</span>
<span id="cb165-5"><a href="finding-pace-across-stages.html#cb165-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">by=</span><span class="st">&#39;code&#39;</span>)</span>
<span id="cb165-6"><a href="finding-pace-across-stages.html#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="finding-pace-across-stages.html#cb165-7" aria-hidden="true" tabindex="-1"></a>off_the_pace_long <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   code code_driver totalDurationGapS cum_dist
## 1  SS1         BER              52.8    31.05
## 2  SS1         BRE               0.0    31.05
## 3  SS1         EVA              13.1    31.05</code></pre>
<p>And now we can plot the simple rebased off-the-pace chart:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="finding-pace-across-stages.html#cb167-1" aria-hidden="true" tabindex="-1"></a>g_otp <span class="ot">=</span> <span class="fu">ggplot</span>(off_the_pace_long, <span class="fu">aes</span>(<span class="at">x=</span>cum_dist, <span class="at">y=</span>totalDurationGapS,</span>
<span id="cb167-2"><a href="finding-pace-across-stages.html#cb167-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">color=</span>code_driver)) <span class="sc">+</span></span>
<span id="cb167-3"><a href="finding-pace-across-stages.html#cb167-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb167-4"><a href="finding-pace-across-stages.html#cb167-4" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Retain the points outside the limits</span></span>
<span id="cb167-5"><a href="finding-pace-across-stages.html#cb167-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can also flip the coordinate axis</span></span>
<span id="cb167-6"><a href="finding-pace-across-stages.html#cb167-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">100</span>, <span class="sc">-</span><span class="dv">100</span>)) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb167-7"><a href="finding-pace-across-stages.html#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="finding-pace-across-stages.html#cb167-8" aria-hidden="true" tabindex="-1"></a>g_otp</span></code></pre></div>
<p><img src="images/finding-stage-pace-off-the-pace-rebased-1.png" width="672" /></p>
<p>Trivially, we might try to add labels at the end of each line:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="finding-pace-across-stages.html#cb168-1" aria-hidden="true" tabindex="-1"></a>off_the_pace_end <span class="ot">=</span> off_the_pace_long <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cum_dist <span class="sc">==</span> <span class="fu">max</span>(cum_dist))</span>
<span id="cb168-2"><a href="finding-pace-across-stages.html#cb168-2" aria-hidden="true" tabindex="-1"></a>                                                </span>
<span id="cb168-3"><a href="finding-pace-across-stages.html#cb168-3" aria-hidden="true" tabindex="-1"></a>g_otp <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="at">data =</span> off_the_pace_end,</span>
<span id="cb168-4"><a href="finding-pace-across-stages.html#cb168-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">x =</span> cum_dist<span class="sc">+</span> <span class="dv">10</span>, <span class="at">y =</span> totalDurationGapS,</span>
<span id="cb168-5"><a href="finding-pace-across-stages.html#cb168-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">label =</span> code_driver, <span class="at">color =</span> code_driver)) <span class="sc">+</span></span>
<span id="cb168-6"><a href="finding-pace-across-stages.html#cb168-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-off-the-pace-end1-1.png" width="672" />
However, there are various other packages that provide alternative ways of doing this, including <code>directlabels</code> and <code>ggrepel</code>.</p>
<p>For example, using <code>directlabels</code>:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="finding-pace-across-stages.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(directlabels)</span>
<span id="cb169-2"><a href="finding-pace-across-stages.html#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="finding-pace-across-stages.html#cb169-3" aria-hidden="true" tabindex="-1"></a>g_otp <span class="sc">+</span></span>
<span id="cb169-4"><a href="finding-pace-across-stages.html#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dl</span>(<span class="fu">aes</span>(<span class="at">label =</span> code_driver, <span class="at">x=</span>cum_dist<span class="sc">+</span><span class="dv">2</span>),</span>
<span id="cb169-5"><a href="finding-pace-across-stages.html#cb169-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cex is text label size</span></span>
<span id="cb169-6"><a href="finding-pace-across-stages.html#cb169-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="fu">list</span>(<span class="st">&#39;last.bumpup&#39;</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb169-7"><a href="finding-pace-across-stages.html#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-off-the-pace-labeled1-1.png" width="672" /></p>
<p>And using <code>ggrepel</code>, which also has the advantage of adding labels for drivers who curves are really of the pace, albeit not in an obviously natural order:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="finding-pace-across-stages.html#cb170-1" aria-hidden="true" tabindex="-1"></a>g_otp <span class="sc">+</span> ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="at">data =</span> off_the_pace_end,</span>
<span id="cb170-2"><a href="finding-pace-across-stages.html#cb170-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">aes</span>(<span class="at">label =</span> code_driver),</span>
<span id="cb170-3"><a href="finding-pace-across-stages.html#cb170-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb170-4"><a href="finding-pace-across-stages.html#cb170-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="images/finding-stage-pace-off-the-pace-labeled2-1.png" width="672" /></p>
<p>The <code>gghighlight</code> package is also useful in highlighting traces, as well as usefully automatically labeling highlighted lines:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="finding-pace-across-stages.html#cb171-1" aria-hidden="true" tabindex="-1"></a>g_otp <span class="sc">+</span></span>
<span id="cb171-2"><a href="finding-pace-across-stages.html#cb171-2" aria-hidden="true" tabindex="-1"></a>    gghighlight<span class="sc">::</span><span class="fu">gghighlight</span>(code_driver<span class="sc">==</span><span class="st">&#39;EVA&#39;</span>,</span>
<span id="cb171-3"><a href="finding-pace-across-stages.html#cb171-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">unhighlighted_params=</span><span class="fu">list</span>(<span class="at">alpha=</span><span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb171-4"><a href="finding-pace-across-stages.html#cb171-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<pre><code>## label_key: code_driver</code></pre>
<p><img src="images/finding-stage-pace-off-the-pace-highlight-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="visualising-results-for-multiple-stages.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="visualising-split-times.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/RallyDataJunkie/rally-event-sketches-2021/edit/master/finding-stage-pace.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/RallyDataJunkie/rally-event-sketches-2021/blob/master/finding-stage-pace.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toc_depth": 3,
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
